---
title: "GLMM example 4"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(tidyverse) #for data wrangling
```

# Scenario

Someone did something for some reason.....

# Read in the data

```{r readData, results='markdown', eval=TRUE}
mckeon = read_csv('../data/mckeon.csv', trim_ws=TRUE)
glimpse(mckeon)
```

Randomized block design

# Exploratory data analysis

Model formula:
$$
y_i \sim{} \mathcal{N}(n, p_i)\\
ln\left(\frac{p_i}{1-p_1}\right) =\boldsymbol{\beta} \bf{X_i} + \boldsymbol{\gamma} \bf{Z_i}
$$

where $\boldsymbol{\beta}$ and $\boldsymbol{\gamma}$ are vectors of the fixed and random effects parameters respectively 
and $\bf{X}$ is the model matrix representing the overall intercept and effects of symbionts on the probability of the colony experiencing predation.
$\bf{Z}$ represents a cell means model matrix for the random intercepts associated with individual coral colonies.

```{r}
mckeon = mckeon %>% mutate(BLOCK = factor(BLOCK), SYMBIONT = factor(SYMBIONT,
                           levels = c('none','crabs','shrimp','both'))) #changes the order
```

# Fit the model
```{r}
#Predation can be encountered or not -> binomial
ggplot(mckeon, aes(y=PREDATION, x = SYMBIONT)) + 
  geom_point(position = position_jitter(width = 0.2, height = 0)) +
  facet_wrap(~BLOCK)
```
```{r}
library(MASS)
mckeon.glmm = glmmPQL(PREDATION ~ SYMBIONT, random = ~1|BLOCK, data = mckeon, family = binomial(link = 'logit'))
```
```{r}
#We try fitting random intercept, random slope
#mckeon.glmm1 = glmmPQL(PREDATION ~ SYMBIONT, random = ~SYMBIONT|BLOCK, data = mckeon, family = binomial(link = 'logit'), control = lmeControl(opt = 'optim'))
#the random slope is the magnitude of difference between treatments. 
#Unfortunately it can't be done with frequentist ways
```

# Model validation

```{r}
plot(mckeon.glmm)
#there is one influental point. the graph needs to be centred around zero, with one suspicious observation.
```

```{r}
summary(mckeon.glmm)
#variability is greater between the blocks rather than within 
#the intercept is in a log scale. we need to back transform it
```
```{r}
library(nlme)
nlme::fixef(mckeon.glmm)
```

```{r}
exp(fixef(mckeon.glmm)) #back transform
```

```{r}
newdata = emmeans(mckeon.glmm, ~SYMBIONT, type = 'response') %>% as.data.frame()

ggplot(newdata, aes(y=prob, x = SYMBIONT))+ geom_pointrange(aes(ymin=lower.CL, ymax = upper.CL))
```


```{r}
#Contrast matrix
cmat = cbind(
  crab_vs_shrimp = c(0,1,-1,0),
  one_vs_both = c(0,-1/2,-1/2,1),
  symbiont = c(1,-1/3, -1/3, -1/3)
)
```

# Model investigation / hypothesis testing

# Predictions

# Summary figures

# References
