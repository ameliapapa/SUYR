---
title: "GLM Part2"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(tidyverse) #for data wrangling
```

# Scenario

@Polis-1998-490 were intested in modelling the presence/absence of lizards (<i>Uta sp.</i>) against the perimeter to area ratio of 19 islands in the Gulf of California.

![Uta lizard](../resources/uta.jpg){width="200" height="137"}

Format of polis.csv data file

ISLAND       RATIO   PA
------------ ------- ----
Bota         15.41   1
Cabeza       5.63    1
Cerraja      25.92   1
Coronadito   15.17   0
..           ..      ..

------------ -----------------------------------------------------------------------------------------
**ISLAND**   Categorical listing of the name of the 19 islands used - variable not used in analysis.
**RATIO**    Ratio of perimeter to area of the island.
**PA**       Presence (1) or absence (0) of *Uta* lizards on island.
------------ -----------------------------------------------------------------------------------------




The aim of the analysis is to investigate the relationship between island parimeter to area ratio and the presence/absence of Uta lizards.

# Read in the data

```{r readData, results='markdown', eval=TRUE}
polis = read_csv('../data/polis.csv', trim_ws=TRUE)
glimpse(polis)
head(polis)
str(polis)
```

 
# Exploratory data analysis

Model formula:
$$
y_i \sim{} \mathcal{Bin}(n, p_i)\\
ln\left(\frac{p_i}{1-p_i}\right) = \beta_0 + \beta_1 x_i
$$
```{r}

ggplot(polis, aes(y=PA, x=RATIO)) +geom_point() +
  geom_smooth(method = 'glm', formula = y~x, method.args = list(family = 'binomial')) #adds binomial smoother (classic sigmoidal shape)
```


# Fit the model
```{r}
polis.glm = glm(PA ~ RATIO, family = binomial(link = 'logit'), data = polis)
```


# Model validation
```{r}
plot(polis.glm)
```
In the residuals vs. leverage graph, we see that observation 3 has a large cook's distance.

#Explore a lack of fit
```{r}
#Comparing sum of squares resid to chi square distribution
polis.resid = sum(resid(polis.glm, type = "pearson")^2)
1-pchisq(polis.resid, polis.glm$df.resid) #0.571>0.05 there is no evidence for lack of fit. Our model is okay.
```
#Deviance
It is like sum of square residuals, instead it uses log likelihoods
```{r}
1-pchisq(polis.glm$deviance, polis.glm$df.residual)
```

```{r}
plot(allEffects(polis.glm, residuals = TRUE), type = 'response')
#the pink dots are the partial residuals
summary(polis.glm)
glance(polis.glm)
```
```{r}
1-(polis.glm$deviance/polis.glm$null) #R squared = 1- (unexplained/Total)
#45% of all variability in where the lizards live depends on the shape of the island!!
```

```{r}
#Threshold ratio
ld50 = -polis.glm$coef[1]/polis.glm$coef[2]
```

# Model investigation / hypothesis testing
```{r}
library(MASS)
ld = dose.p(polis.glm, p = c(0.5,0.9))
ld.SE = attr(ld, "SE")
ld = data.frame(LD = attr(ld,'p'),
                Dose = as.vector(ld),
                SE = ld.SE) %>%
  mutate(lower = Dose - SE*qnorm(0.975), #confidence intervals
         upper = Dose + SE*qnorm(0.975)) 
ld 
```


# Predictions



# Summary figures
```{r}
polis.grid = with(polis, list(RATIO = seq(min(RATIO), max(RATIO), len = 100)))
newdata = emmeans(polis.glm, ~RATIO, at = polis.grid, type = 'response') %>% as.data.frame()

newdata %>% ggplot(aes(y=prob, x = RATIO)) + 
  geom_point(data = polis, aes(RATIO, PA))+
  geom_ribbon(aes(ymin = asymp.LCL, ymax = asymp.UCL), fill = 'blue', alpha = 0.2) +
  geom_line() +
  theme_bw()
```



# References
