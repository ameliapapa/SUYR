---
title: "Bayesian GLMM example 4"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(tidyverse) #for data wrangling
```

# Scenario

Someone did something for some reason.....

# Read in the data

```{r readData, results='markdown', eval=TRUE}
mckeon = read_csv('../data/mckeon.csv', trim_ws=TRUE)
glimpse(mckeon)
```


# Exploratory data analysis

Model formula:
$$
y_i \sim{} \mathcal{N}(n, p_i)\\
ln\left(\frac{p_i}{1-p_1}\right) =\boldsymbol{\beta} \bf{X_i} + \boldsymbol{\gamma} \bf{Z_i}
$$

where $\boldsymbol{\beta}$ and $\boldsymbol{\gamma}$ are vectors of the fixed and random effects parameters respectively 
and $\bf{X}$ is the model matrix representing the overall intercept and effects of symbionts on the probability of the colony experiencing predation.
$\bf{Z}$ represents a cell means model matrix for the random intercepts associated with individual coral colonies.


```{r}
mckeon = mckeon %>% mutate(BLOCK = factor(BLOCK), SYMBIONT = factor(SYMBIONT, levels = c('none','crabs','shrimp','both')))
ggplot(mckeon, aes(SYMBIONT, PREDATION)) + geom_point(position = position_jitter(width = 0.2, height = 0)) + facet_wrap(~BLOCK)
```



# Fit the model
```{r, cache=T}
mckeon.rstan = stan_glmer(PREDATION~SYMBIONT + (1|BLOCK), data = mckeon, family = binomial(link = 'logit'), 
                          iter = 4000, warmup = 1000, chains = 3, thin = 5,  
                          refresh = 0, cores = 3)
mckeon.rstan1 = stan_glmer(PREDATION~SYMBIONT + (SYMBIONT|BLOCK), data = mckeon, 
                           family = binomial(link = 'logit'),
                           prior = normal(0, 1, autoscale = FALSE),
                          iter = 4000, warmup = 2000, chains = 3, thin = 5,  
                          refresh = 0, cores = 3)
```

```{r}
#loo(mckeon.rstan) didn't work
waic(mckeon.rstan) #56.1
waic(mckeon.rstan1) #42.9
```


```{r}
colnames(as.matrix(mckeon.rstan1))
nms = colnames(as.matrix(mckeon.rstan1))
wch = grep('^.Intercept|^SYMBIONT|^Sigma',nms)
stan_trace(mckeon.rstan1, pars = nms[wch])
stan_ac(mckeon.rstan1, pars = nms[wch])
stan_ess(mckeon.rstan1, pars = nms[wch])
stan_rhat(mckeon.rstan1, pars = nms[wch])
```

```{r}
posterior_vs_prior(mckeon.rstan1, color_by = 'vs', group_by = T,
                   facet_args = list(scales='free_y'))
```

```{r}
ggpredict(mckeon.rstan1) %>% plot
```


# Model investigation

```{r}
tidyMCMC(mckeon.rstan1$stanfit, conf.int = T, conf.method = 'HPDinterval',rhat = T, ess = T, pars = nms[wch])
```

```{r}
exp(2.637) # ratio of being predated and not predated
```

```{r}
binomial()$linkinv(3.46) #probability of not being predated in the no symbiont group is 96.5%
```

# Pairwise comparisons to compare each treatment group

```{r}
mckeon.em emmeans(mckeon.rstan, pairwise~SYMBIONT, type = 'response')$contrasts
```

```{r}
mckeon.em = emmeans(mckeon.rstan, pairwise~SYMBIONT, type = 'link')$contrasts %>% gather_emmeans_draws() %>%
  mutate(PEff=exp(.value))
mckeon.em %>% 
  group_by(contrast) %>% 
  summarize(Prob = sum(PEff>1)/n())
```

```{r}
newdata = emmeans(mckeon.rstan, ~SYMBIONT, type = 'response') %>% as.data.frame
head(newdata)
ggplot(newdata, aes(y = prob, x = SYMBIONT)) + geom_pointrange(aes(ymin = lower.HPD, ymax = upper.HPD))
```

# Predictions

```{r}
cmat = cbind('Cont' = c(0,0.5, 0.5, -1))
emmeans(mckeon.rstan1, ~SYMBIONT, contr = list(cmat), type = 'response')
#Youre two times more likely to be predated on if you have one symbiont (crab OR shrimp) compared to both.
#odds.ratio = 2.29

emmeans(mckeon.rstan1, ~SYMBIONT, contr = list(cmat), type = 'response')$contrast %>% 
  gather_emmeans_draws() %>%
  summarize(sum(exp(.value)>1)/n())
#You're 78% more likely to be predated on if you have 1 symbiont instead of 2
```


# Summary figures

# References
