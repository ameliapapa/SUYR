---
title: "Bayesian GLM Part4"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE}
library(rstanarm)   #for fitting models in STAN
library(coda)       #for diagnostics
library(bayesplot)  #for diagnostics
library(rstan)      #for interfacing with STAN
library(emmeans)    #for marginal means etc
library(broom)      #for tidying outputs
library(tidybayes)  #for more tidying outputs
library(ggeffects)  #for partial plots
library(tidyverse)  #for data wrangling etc
```

# Scenario

Here is a modified example from @Quinn-2002-2002. Day and Quinn
(1989) described an experiment that examined how rock surface type
affected the recruitment of barnacles to a rocky shore. The experiment
had a single factor, surface type, with 4 treatments or levels: algal
species 1 (ALG1), algal species 2 (ALG2), naturally bare surfaces (NB)
and artificially scraped bare surfaces (S). There were 5 replicate plots
for each surface type and the response (dependent) variable was the
number of newly recruited barnacles on each plot after 4 weeks.

![Six-plated barnacle](../resources/barnacles.jpg){width="224" height="308"}

Format of day.csv data files

TREAT   BARNACLE
------- ----------
ALG1    27
..      ..
ALG2    24
..      ..
NB      9
..      ..
S       12
..      ..

-------------- ----------------------------------------------------------------------------------------------------------------------------------------------
**TREAT**      Categorical listing of surface types. ALG1 = algal species 1, ALG2 = algal species 2, NB = naturally bare surface, S = scraped bare surface.
**BARNACLE**   The number of newly recruited barnacles on each plot after 4 weeks.
-------------- ----------------------------------------------------------------------------------------------------------------------------------------------



# Read in the data

```{r readData, results='markdown', eval=TRUE}
day = read_csv('../data/day.csv', trim_ws=TRUE)
glimpse(day)
```



# Exploratory data analysis

Model formula:
$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0,10)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,1)\\
\end{align}
$$

where $\boldsymbol{\beta}$ is a vector of effects parameters and $\bf{X}$ is a model matrix representing the intercept and treatment contrasts for the effects of Treatment on barnacle recruitment.

# Fit the model

```{r fitModel, results='markdown', eval=TRUE}
day.rstan <- stan_glm(BARNACLE ~ TREAT, data=day,
                      family='poisson',
                      chains = 3,iter = 2000, thin=2, refresh=0)
prior_summary(day.rstan)

day.rstan <- stan_glm(BARNACLE ~ TREAT, data=day, family='poisson',
                      prior = normal(c(0,0,0), c(10,10,10)),
                      prior_intercept = normal(0,1),
                      chains = 3,iter = 2000, thin=2)
prior_summary(day.rstan)

stan_trace(day.rstan) 
stan_ac(day.rstan) 
stan_rhat(day.rstan) 
stan_ess(day.rstan)

## plot(day.rstan, 'mcmc_trace')
## plot(day.rstan, 'mcmc_acf_bar')
## plot(day.rstan, 'mcmc_rhat_hist')
## plot(day.rstan, 'mcmc_neff_hist')
posterior_vs_prior(day.rstan, color_by='vs', group_by=TRUE,
                   facet_args=list(scales='free_y'))

pp_check(day.rstan, x=as.numeric(day$TREAT),'intervals')


##Deviance residuals (for plotting residuals)
y=day.rstan$y
res=resid(day.rstan)
mu=fitted(day.rstan)
ggplot(data=NULL) +
  geom_point(aes(y=res, x=mu))
RSS = sum(res^2)
RSS/(length(y)-4)

y=day.rstan$y
mu=fitted(day.rstan)
#wt=day.rstan$weights
r=poisson()$dev.resids(y,mu,wt=1)
#r=poisson()$dev.resids(y,mu,wt=wt)
res <- sqrt(pmax(r, 0))
resid=ifelse(y > mu, res, -res)
ggplot(data=NULL) +
    geom_point(aes(y=resid, x=mu))
RSS = sum(resid^2)
RSS/(length(y)-4)
## hmmm not right


## Compare the proportion of zeros in the observed and expected data
#yrep = posterior_predict(day.rstan)
prop_zero <- function(y) mean(y == 0)
(prop_zero_test1 <- pp_check(day.rstan, plotfun = "stat", stat = "prop_zero"))
                                        # no zeros - so not zero inflated


day.rstanNB <- stan_glm(BARNACLE ~ TREAT, data=day,
                      family='neg_binomial_2',
                      chains = 3,iter = 2000, thin=2, refresh=0)

y=day.rstanNB$y
mu=fitted(day.rstanNB)
(theta = mean(as.matrix(day.rstanNB)[,'reciprocal_dispersion']))
r=MASS:::neg.bin(theta)$dev.resids(y,mu,wt=1)
#r=2 * wt * (y * log(pmax(1, y)/mu) - (y + theta) * log((y + theta)/(mu + theta)))
res <- sqrt(pmax(r, 0))
resid=ifelse(y > mu, res, -res)
#ggplot(data=NULL) +
#    geom_point(aes(y=resid, x=mu))
RSS = sum(resid^2)
RSS/(Norw(day)-4)

## y=day.rstanNB$y
## mu=fitted(day.rstanNB)
## #wt=day.rstan$weights
## r=poisson()$dev.resids(y,mu,wt=1)
## #r=poisson()$dev.resids(y,mu,wt=wt)
## res <- sqrt(pmax(r, 0))
## resid=ifelse(y > mu, res, -res)
## ggplot(data=NULL) +
##     geom_point(aes(y=resid, x=mu))
## RSS = sum(resid^2)
## RSS/(length(y)-4)

day.rstanNB <- update(day.rstan, family = neg_binomial_2)
(loo.P=loo(day.rstan))
(loo.NB=loo(day.rstanNB))
compare_models(loo.P, loo.NB)

ggpredict(day.rstanNB, term='TREAT') %>% plot
ggpredict(day.rstanNB, ~TREAT) %>% plot
ggemmeans(day.rstanNB, ~TREAT) %>% plot


summary(day.rstanNB)
library(tidybayes)
tidyMCMC(day.rstanNB$stanfit, conf.int=TRUE,
         conf.method='HPDinterval', rhat=TRUE,ess=TRUE)


# Pairwise comparisons
library(emmeans)
## factor statements
emmeans(day.rstanNB, pairwise~TREAT, type='response')
## what about probabilities
day.em = emmeans(day.rstanNB, pairwise~TREAT, type='link')$contrasts %>%
    gather_emmeans_draws() %>%
    mutate(Fit=exp(.value))
day.em %>% head
day.em %>% group_by(contrast) %>%
    ggplot(aes(x=Fit)) +
    geom_histogram() +
    geom_vline(xintercept=1, color='red') + 
    facet_wrap(~contrast, scales='free')
day.em %>% group_by(contrast) %>% median_hdi()
# Probability of effect
day.em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day.em %>% group_by(contrast) %>% summarize(P=sum(Fit>1.1)/n())


##Planned contrasts
cmat<-cbind('Alg2_Alg1'=c(-1,1,0,0),
              'NB_S'=c(0,0,1,-1),
             'Alg_Bare'=c(0.5,0.5,-0.5,-0.5),
             'Alg_S'=c(0.5,0.5,-1,0))
crossprod(cmat)
emmeans(day.rstanNB, ~TREAT, contr=list(TREAT=cmat), type='link')
emmeans(day.rstanNB, ~TREAT, contr=list(TREAT=cmat), type='response')
day.em = emmeans(day.rstanNB, ~TREAT, contr=list(TREAT=cmat), type='link')$contrasts %>%
      gather_emmeans_draws() %>% mutate(Fit=exp(.value)) 
day.em %>% group_by(contrast) %>% mean_hdi()
# Probability of effect
day.em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day.em %>% group_by(contrast) %>% summarize(P=sum(Fit>=1.5)/n())

hist(bayes_R2(day.rstanNB))

bayes_R2(day.rstanNB) %>% median_hdi
bayes_R2(day.rstanNB) %>% hist


## Summary plot
day.grid = with(day, list(TREAT=levels(TREAT)))
newdata = emmeans(day.rstanNB, ~TREAT, type='response') %>% as.data.frame
head(newdata)
ggplot(newdata, aes(y=prob, x=TREAT)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD))
```

                                           
# Model validation

# Model investigation / hypothesis testing

# Predictions

# Summary figures

# References
