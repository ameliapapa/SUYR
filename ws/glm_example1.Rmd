---
title: "GLM Part1"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, warning=TRUE, message=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
#library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(tidyverse) #for data wrangling
```

# Scenario

Here is an example from @Fowler-1998-1998. An agriculturalist was interested in the effects of fertilizer load on the yield of grass.  Grass seed was sown uniformly over an area and different quantities of commercial fertilizer were applied to each of ten 1 m<sup>2</sup> randomly located plots.  Two months later the grass from each plot was harvested, dried and weighed.  The data are in the file **fertilizer.csv** in the **data** folder.

![](../resources/turf.jpg){width=70%}

| FERTILIZER   | YIELD   |
| ------------ | ------- |
| 25           | 84      |
| 50           | 80      |
| 75           | 90      |
| 100          | 154     |
| 125          | 148     |
| \...         | \...    |

---------------- ---------------------------------------------------
**FERTILIZER**:  Mass of fertilizer (g.m^-2^) - Predictor variable
**YIELD**:       Yield of grass (g.m^-2^) - Response variable
---------------- ---------------------------------------------------
 
 
The aim of the analysis is to investigate the relationship between fertilizer concentration and grass yield.

# Read in the data

```{r readData, results='markdown', eval=TRUE, warning=FALSE}
library(readr)
fert <- read.csv("~/Desktop/AIMS/SUYR/data/fertilizer.csv")
glimpse(fert)
head(fert)
str(fert)
```

# Exploratory data analysis
Is there a linear relationship between Yield and fertilizer
Model formula:
$$
y_i \sim{} \mathcal{N}(\mu_i, \sigma^2)\\
\mu_i = \beta_0 + \beta_1 x_i
$$


# Fit the model
```{r}
fert.lm = lm(YIELD ~ FERTILIZER, data = fert)
par(mfrow =c(2,2))
plot(fert.lm)
summary(fert.lm) 
#The estimate of the intercept is 51.93333 and the slope estimate is 0.81139
```
```{r}
names(fert.lm)
```


# Model validation
Cook's distance - combined effect of residual and leverage
```{r}
#partial effects plot:
plot(allEffects(fert.lm, residuals = T))
#the blue line represents the regression line. the pink line is a smoother (locally weighted regression smoother).
```


# Model investigation / hypothesis testing
```{r}
summary(fert.lm)
```
#Confidence intervals
```{r}
confint(fert.lm)
```
The interval of the confidence interval of effect size (0.6184496, 1.004338) doesn't include 0!
```{r}
tidy(fert.lm, conf.int = T)
```

# Predictions
1. 
```{r}
newdata = data.frame(FERTILIZER=110)
Xmat = model.matrix(~FERTILIZER, data = newdata)
coef(fert.lm) %*% t(Xmat) #reverses the matrix multiplication
```
```{r}
newdata = data.frame(FERTILIZER=c(110,200,210))
Xmat = model.matrix(~FERTILIZER, data = newdata)
coef(fert.lm) %*% t(Xmat)#now we're predicting 3 values
predict(fert.lm, newdata = newdata) #does same shit
#it gets better...
emmeans(fert.lm, ~FERTILIZER, at = newdata) %>% as.data.frame() #keeps it from rounding up values
#emmeans has the ability to predict from any model you throw at it
```

# Summary figures
```{r}
fert_grid = with(fert, list(FERTILIZER = seq(min(FERTILIZER), max(FERTILIZER), len = 100)))
newdata = emmeans(fert.lm, ~FERTILIZER, at = fert_grid) %>% as.data.frame()
plot(newdata$FERTILIZER, newdata$emmean)
##OR
newdata %>% ggplot(aes(FERTILIZER,emmean)) +geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax =upper.CL), fill = '#FF0000', alpha = 0.3) + #alpha changes the transparency
  theme_bw() +
  scale_y_continuous(name = expression(Grass~yield~(g.m^-3))) +
  geom_point(data = fert,aes(y = YIELD))
```


# References
